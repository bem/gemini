#!/usr/bin/env node
'use strict';
var path = require('path'),
    fs = require('fs'),
    resolve = require('resolve'),
    chalk = require('chalk'),
    ownVersion = require('../package.json').version;

require('source-map-support/register');

function getGeminiRoot() {
    var localPackage;
    try {
        // try local module first
        localPackage = resolve.sync('gemini/package.json', {
            basedir: process.cwd()
        });
    } catch (e) {
        // if fails, use global package
        return path.resolve(__dirname, '..');
    }

    var localModule = path.dirname(localPackage),
        localVersion = require(localPackage).version;

    if (ownVersion !== localVersion) {
        console.error(chalk.yellow('WARNING'));
        console.error('Running local gemini from %s', chalk.cyan(localModule));
        console.error('Version: %s', chalk.red(localVersion));
        console.error('Global: %s', chalk.green(ownVersion));
        console.error('');
    }
    return localModule;
}

function loadModule(rootPath) {
    var srcCli = getCliModulePath(rootPath, 'src');
    if (fs.existsSync(srcCli)) {

        require('babel-register');
        return require(srcCli);
    }

    return require(getCliModulePath(rootPath, 'lib'));
}

function getCliModulePath(rootPath, sourceDir) {
    return path.join(rootPath, sourceDir, 'cli', 'index.js')
}

function loadCliModule() {
    return loadModule(getGeminiRoot());
}

loadCliModule().run();
